<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI PR Risk Gate • Dashboard</title>
  <link rel="stylesheet" href="/theme.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Cormorant+Garamond:wght@500;600&display=swap');
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Manrope,system-ui,sans-serif;color:var(--text)}
    .wrap{max-width:1180px;margin:40px auto;padding:0 24px}
    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .nav a{text-decoration:none;color:var(--text);border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:999px;font-size:12px;letter-spacing:.04em;text-transform:uppercase}
    .nav a.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap}
    .title{font-size:30px;font-weight:600;font-family:"Cormorant Garamond",Georgia,serif;letter-spacing:.2px;line-height:1.1}
    .toolbar{display:flex;gap:8px;align-items:center}
    select,input{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:8px;color:var(--text);font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 8px 22px rgba(31,26,23,.05)}
    .k{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.08em}.v{font-size:28px;font-weight:750;margin-top:8px}
    .main{display:grid;grid-template-columns:1.7fr 1fr;gap:16px;margin-bottom:16px}
    .sub{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    table{width:100%;border-collapse:collapse} th,td{font-size:13px;padding:11px 10px;border-bottom:1px solid var(--line);text-align:left} th{color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em;font-size:11px}
    .sev{font-weight:700}.sev.low{color:var(--good)}.sev.medium{color:var(--warn)}.sev.high,.sev.critical{color:var(--bad)}
    .chart{height:220px;display:flex;align-items:flex-end;gap:6px;border-top:1px solid var(--line);padding-top:8px}
    .bar{flex:1;background:linear-gradient(180deg,#bea382,var(--accent));border-radius:6px 6px 0 0;min-width:8px;position:relative}
    .bar span{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);font-size:11px;color:var(--muted);white-space:nowrap;margin-bottom:4px}
    .legend{display:flex;gap:10px;font-size:12px;color:var(--muted);margin-top:8px}.dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:4px}
    @media(max-width:1020px){.grid{grid-template-columns:repeat(2,1fr)}.main{grid-template-columns:1fr}.sub{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav" aria-label="Primary">
      <a href="/">Analyzer</a>
      <a class="active" href="/dashboard">Dashboard</a>
      <a href="/openapi.yaml" target="_blank" rel="noreferrer">API Spec</a>
      <a href="/docs/onboarding" target="_blank" rel="noreferrer">Onboarding</a>
    </nav>
    <div class="top">
      <div class="title">AI PR Risk Gate Dashboard</div>
      <div class="toolbar">
        <input id="repo" placeholder="repo filter (optional)" />
        <select id="days"><option value="7">7d</option><option value="30" selected>30d</option><option value="90">90d</option></select>
        <button id="apply" style="border:0;background:var(--accent);color:#fff;border-radius:8px;padding:9px 12px;cursor:pointer">Apply</button>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div class="k">Assessments</div><div class="v" id="total">—</div></div>
      <div class="card"><div class="k">Average Risk</div><div class="v" id="avg">—</div></div>
      <div class="card"><div class="k">Latest Severity</div><div class="v" id="latest">—</div></div>
      <div class="card"><div class="k">High/Critical</div><div class="v" id="highCount">—</div></div>
    </div>

    <div class="main">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Risk Trend</div>
        <div id="chart" class="chart"></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Severity Distribution</div>
        <table><thead><tr><th>Severity</th><th>Count</th></tr></thead><tbody id="severityRows"></tbody></table>
      </div>
    </div>

    <div class="sub">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Recent Assessments</div>
        <table><thead><tr><th>Time</th><th>Repo</th><th>PR</th><th>Score</th><th>Severity</th></tr></thead><tbody id="recentRows"></tbody></table>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Top Findings</div>
        <table><thead><tr><th>Finding</th><th>Count</th></tr></thead><tbody id="findingRows"></tbody></table>
      </div>
    </div>
  </div>

<script>
async function fetchJson(url){const r=await fetch(url);return r.json();}
const escapeHtml=(s)=>String(s)
  .replaceAll('&','&amp;')
  .replaceAll('<','&lt;')
  .replaceAll('>','&gt;')
  .replaceAll('"','&quot;')
  .replaceAll("'",'&#39;');

function renderChart(rows){
  const chart=document.getElementById('chart');
  if(!rows.length){chart.innerHTML='<div style="color:var(--muted)">No trend data yet.</div>';return;}
  const max=Math.max(...rows.map(r=>Number(r.avgScore)||0),1);
  chart.innerHTML=rows.map(r=>{
    const h=Math.max(8,Math.round(((Number(r.avgScore)||0)/max)*180));
    return `<div class="bar" style="height:${h}px" title="${r.day}: ${r.avgScore}"><span>${r.day.slice(5)}</span></div>`;
  }).join('');
}

async function load(){
  const repo=document.getElementById('repo').value.trim();
  const days=document.getElementById('days').value;
  const q=new URLSearchParams();
  q.set('days',days);
  if(repo) q.set('repo',repo);

  const [recent,trends,severity,findings]=await Promise.all([
    fetchJson('/api/recent?limit=20'+(repo?`&repo=${encodeURIComponent(repo)}`:'')),
    fetchJson('/api/trends?'+q.toString()),
    fetchJson('/api/severity?'+q.toString()),
    fetchJson('/api/findings?'+q.toString())
  ]);

  const rows=recent.rows||[];
  document.getElementById('total').textContent=String(rows.length);
  document.getElementById('avg').textContent=rows.length?(rows.reduce((a,r)=>a+r.score,0)/rows.length).toFixed(1):'0.0';
  const latest=rows[0]?.severity||'n/a';
  document.getElementById('latest').innerHTML=`<span class="sev ${latest}">${String(latest).toUpperCase()}</span>`;
  document.getElementById('highCount').textContent=String(rows.filter(r=>['high','critical'].includes(r.severity)).length);

  document.getElementById('recentRows').innerHTML=rows.map(r=>`<tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${escapeHtml(r.repo)}</td><td>#${Number(r.pr_number)}</td><td>${Number(r.score)}</td><td class="sev ${escapeHtml(r.severity)}">${escapeHtml(String(r.severity).toUpperCase())}</td></tr>`).join('')||'<tr><td colspan="5">No data.</td></tr>';
  document.getElementById('severityRows').innerHTML=(severity.rows||[]).map(r=>`<tr><td class="sev ${escapeHtml(r.severity)}">${escapeHtml(String(r.severity).toUpperCase())}</td><td>${Number(r.count)}</td></tr>`).join('')||'<tr><td colspan="2">No data.</td></tr>';
  document.getElementById('findingRows').innerHTML=(findings.rows||[]).map(r=>`<tr><td>${escapeHtml(r.finding)}</td><td>${Number(r.count)}</td></tr>`).join('')||'<tr><td colspan="2">No data.</td></tr>';
  renderChart(trends.trends||[]);
}

document.getElementById('apply').addEventListener('click',load);
load();
</script>
</body>
</html>
